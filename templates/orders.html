{% extends "base.html" %}
{% block title %}Order Requests{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <h2 style="margin-bottom: 0;">Order Requests</h2>
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
            <form method="GET" style="display: flex; gap: 8px; align-items: center;">
                <select name="status" style="width: auto;" onchange="this.form.submit()">
                    <option value="">All Status</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="ordered" {% if status_filter == 'ordered' %}selected{% endif %}>Ordered</option>
                    <option value="received" {% if status_filter == 'received' %}selected{% endif %}>Received</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    <option value="refused" {% if status_filter == 'refused' %}selected{% endif %}>Refused</option>
                </select>
                {% if status_filter %}
                    <a href="{{ url_for('orders') }}" class="btn btn-warning btn-sm">Clear</a>
                {% endif %}
            </form>
            {% if current_role == 'admin' and rows %}
                <form method="POST" action="{{ url_for('delete_all_orders') }}" style="margin-left: 8px;"
                      onsubmit="return confirm('Delete ALL order requests ({{ rows|length }} records)? This cannot be undone.')">
                    <button type="submit" class="btn btn-danger btn-sm" style="font-size: 12px;">Delete All History</button>
                </form>
            {% endif %}
        </div>
    </div>
</div>

<div class="card" style="overflow-x: auto;">
    {% if rows %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Location</th>
                <th>Item</th>
                <th>Minimum</th>
                <th>Qty to Order</th>
                <th>Requested By</th>
                <th>Group</th>
                <th>Status</th>
                <th>Note</th>
                <th>Created (KST)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td>{{ row.id }}</td>
                <td>{{ row.stock_place }}</td>
                <td><strong>{{ row.item_name }}</strong></td>
                <td>{{ row.minimum }}</td>
                <td>{{ row.quantity_needed }}</td>
                <td>{{ row.requested_by }}</td>
                <td>{{ row.requested_by_group }}</td>
                <td>
                    {% if row.status == 'pending' %}
                        <span style="background: #ff9800; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">Pending</span>
                    {% elif row.status == 'ordered' %}
                        <span style="background: #2196f3; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">Ordered</span>
                    {% elif row.status == 'received' %}
                        <span style="background: #4caf50; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">Received</span>
                    {% elif row.status == 'cancelled' %}
                        <span style="background: #9e9e9e; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">Cancelled</span>
                    {% elif row.status == 'refused' %}
                        <span style="background: #b71c1c; color: white; padding: 2px 10px; border-radius: 10px; font-size: 12px;">Refused</span>
                    {% endif %}
                </td>
                <td>{{ row.note }}</td>
                <td style="font-size: 12px;">{{ row.created_at if row.created_at else '' }}</td>
                <td style="white-space: nowrap;">
                    {% if row.status == 'pending' %}
                        {% if current_role == 'admin' %}
                            <form method="POST" action="{{ url_for('update_order', order_id=row.id) }}" style="display:inline;">
                                <input type="hidden" name="status" value="ordered">
                                <button type="submit" class="btn btn-primary btn-sm" style="font-size:11px;">Mark Ordered</button>
                            </form>
                            <form method="POST" action="{{ url_for('update_order', order_id=row.id) }}" style="display:inline;"
                                  onsubmit="return confirm('Refuse this order request?')">
                                <input type="hidden" name="status" value="refused">
                                <button type="submit" class="btn btn-danger btn-sm" style="font-size:11px;">Refuse</button>
                            </form>
                        {% endif %}
                        {% if current_role == 'admin' or current_group == row.requested_by_group %}
                            <form method="POST" action="{{ url_for('update_order', order_id=row.id) }}" style="display:inline;">
                                <input type="hidden" name="status" value="cancelled">
                                <button type="submit" class="btn btn-warning btn-sm" style="font-size:11px;">Cancel</button>
                            </form>
                        {% endif %}
                    {% elif row.status == 'ordered' %}
                        {% if current_role == 'admin' %}
                            <form method="POST" action="{{ url_for('update_order', order_id=row.id) }}" style="display:inline;">
                                <input type="hidden" name="status" value="received">
                                <button type="submit" class="btn btn-success btn-sm" style="font-size:11px;">Received</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <span style="font-size:11px; color:#666;">
                            {% if row.resolved_by %}by {{ row.resolved_by }}{% endif %}
                            {% if row.resolved_at %}<br>{{ row.resolved_at }}</span>{% endif %}
                        </span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="text-align: center; color: #888; padding: 40px;">No order requests found.</p>
    {% endif %}
</div>
{% endblock %}
